Конфигурация дополнительных параметров в WSL
============================================

* Статья
* 21.03.2023
* Участники: 23

Обратная связь

Файлы [wsl.conf](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconf) и [.wslconfig](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconfig) используются для настройки дополнительных параметров на основе каждого распределения (`wsl.conf`) и глобально во всех дистрибутивах WSL 2 (`.wslconfig`). В этом руководстве рассматриваются все параметры параметров, когда следует использовать каждый тип файла, где хранить файл, примеры файлов параметров и советы.

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#what-is-the-difference-between-wslconf-and-wslconfig)
В чем разница между wsl.conf и wslconfig?
-----------------------------------------

Вы можете настроить параметры для установленных дистрибутивов Linux, которые будут автоматически применяться при каждом запуске WSL двумя способами:

* **[.wslconfig](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconfig)** для **глобальной** настройки параметров во всех установленных дистрибутивах, работающих в WSL 2.
* **[wsl.conf](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconf)** для настройки параметров **для дистрибутивов** Linux, работающих в WSL 1 или WSL 2.

Оба типа файлов используются для настройки параметров WSL, но расположение, в котором хранится файл, область конфигурации и версия WSL, на которой выполняется дистрибутив, влияют на выбранный тип файла.

Версия WSL, которую вы используете, повлияет на параметры конфигурации. WSL 2 выполняется как упрощенная виртуальная машина, поэтому использует параметры виртуализации, позволяющие управлять объемом используемой памяти или процессоров (что может быть знакомо при использовании Hyper-V или VirtualBox).

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconf)
wsl.conf
--------

* Хранится в каталоге `/etc` дистрибутива в виде файла UNIX.
* Используется для настройки параметров для каждого распределения. Параметры, настроенные в этом файле, будут применяться только к определенному дистрибутиву Linux, который содержит каталог, в котором хранится этот файл.
* Может использоваться для дистрибутивов, работающих с любой версией, WSL 1 или WSL 2.
* Чтобы получить доступ к каталогу `/etc` установленного дистрибутива, используйте командную строку дистрибутива с `cd /` для доступа к корневому каталогу, а затем `ls` для вывода списка файлов или `explorer.exe .` просмотра в Windows проводник. Путь к каталогу должен выглядеть примерно так: `/etc/wsl.conf`.

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconfig)
WSLCONFIG
---------

* Хранится в каталоге `%UserProfile%` .
* Используется для глобальной настройки параметров во всех установленных дистрибутивах Linux, работающих под управлением версии WSL 2.
* Может использоваться **только для дистрибутивов, выполняемых WSL 2**. Дистрибутивы, работающие под управлением WSL 1, не будут затронуты этой конфигурацией, так как они не работают как виртуальная машина.
* Чтобы получить доступ к каталогу`%UserProfile%`, в PowerShell используйте `cd ~` для доступа к домашнему каталогу (обычно это ваш профиль `C:\Users\<UserName>`пользователя) или откройте windows проводник и введите `%UserProfile%` в адресной строке. Путь к каталогу должен выглядеть примерно так: `C:\Users\<UserName>\.wslconfig`.

WSL обнаруживает существование этих файлов, считывает содержимое и автоматически применяет параметры конфигурации при каждом запуске WSL. Если файл отсутствует или имеет неправильный формат (неправильное форматирование разметки), WSL будет по-прежнему запускаться в обычном режиме без применения параметров конфигурации.

[Проверьте версию WSL, которую вы используете.](https://learn.microsoft.com/ru-ru/windows/wsl/install#check-which-version-of-wsl-you-are-running)

 Примечание

Настройка параметров распространения с помощью файла wsl.conf доступна только в сборке Windows 17093 и более поздних версиях.

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#the-8-second-rule)

### Правило 8 секунд

Для отображения обновлений параметров конфигурации необходимо подождать, пока подсистема, на котором работает дистрибутив Linux, полностью остановится и перезапустится. Обычно это занимает около 8 секунд после закрытия всех экземпляров оболочки распределения.

Если вы запускаете дистрибутив (т. е. Ubuntu), измените файл конфигурации, закройте дистрибутив и снова запустите его. Можно предположить, что изменения конфигурации сразу же вступили в силу. В настоящее время это не так, так как подсистема все еще может быть запущена. Перед повторным запуском необходимо дождаться остановки подсистемы, чтобы дать достаточно времени для получения изменений. Вы можете проверить, запущен ли дистрибутив Linux (оболочка) после его закрытия, с помощью PowerShell с командой `wsl --list --running`: . Если дистрибутивы не запущены, вы получите ответ "Нет запущенных дистрибутивов". Теперь можно перезапустить дистрибутив, чтобы просмотреть примененные обновления конфигурации.

Команда `wsl --shutdown` — это быстрый путь к перезапуску дистрибутивов WSL 2, но она завершит работу всех запущенных дистрибутивов, поэтому используйте их с умом.

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#configuration-settings-for-wslconf)
Параметры конфигурации для wsl.conf
-----------------------------------

Файл wsl.conf настраивает параметры для каждого распределения. _(Сведения о глобальной конфигурации дистрибутивов WSL 2 см. в разделе [.wslconfig](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconfig))._

Файл wsl.conf поддерживает четыре раздела: `automount`, `network`, `interop`и `user`. _(По модели .ini соглашений о файлах ключи объявляются в разделе, например файлы .gitconfig.)_ Сведения о том, где хранить файл wsl.conf, см. в разделе [wsl.conf](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconf) .

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#systemd-support)

### Поддержка systemd

Многие дистрибутивы Linux по умолчанию работают под управлением systemd (включая Ubuntu), и WSL недавно добавил поддержку этого диспетчера систем или служб, чтобы WSL был еще более похож на использование ваших любимых дистрибутивов Linux на компьютере без операционной системы. Для включения systemd потребуется WSL версии 0.67.6+. Проверьте версию WSL с помощью команды `wsl --version`. Если вам нужно выполнить обновление, вы можете получить [последнюю версию WSL в Microsoft Store](https://aka.ms/wslstorepage). Дополнительные сведения см. в [объявлении блога](https://devblogs.microsoft.com/commandline/a-preview-of-wsl-in-the-microsoft-store-is-now-available/).

Чтобы включить systemd, откройте `wsl.conf` файл в текстовом редакторе, используя `sudo` для разрешений администратора, и добавьте следующие строки в `/etc/wsl.conf`:

BashКопировать
    [boot]systemd=true

Затем необходимо закрыть дистрибутив WSL с помощью `wsl.exe --shutdown` PowerShell, чтобы перезапустить экземпляры WSL. После перезапуска дистрибутива должна быть запущена systemd. Вы можете подтвердить с помощью команды : `systemctl list-unit-files --type=service`, которая отобразит состояние служб.

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#automount-settings)

### Параметры автоматического подключения

Метка раздела: `[automount]`

| ключ       | value                                                                        | default       | HDInsight                                                                                                                                                                                                                                                                                                          |
| ---------- | ---------------------------------------------------------------------------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Включено   | Логическое                                                                   | Да            | `true`вызывает автоматическое подключение фиксированных дисков (т. е`C:/`. или `D:/`) к DrvFs в .`/mnt` `false` означает, что диски не будут подключены автоматически, но вы по-прежнему можете подключить их вручную или с помощью `fstab`.                                                                       |
| mountFsTab | Логическое                                                                   | Да            | Значение `true` задает `/etc/fstab` для обработки при запуске WSL. /etc/fstab — это файл, в котором можно объявлять другие файловые системы, например общий ресурс SMB. Поэтому вы можете автоматически подключать эти файловые системы в WSL при запуске.                                                         |
| root       | строка                                                                       | `/mnt/`       | Задает каталог, в который будут автоматически подключены несъемные диски. По умолчанию для этого параметра задано значение `/mnt/`, поэтому ваш C-диск файловой системы Windows подключен к `/mnt/c/`. Если вы измените `/mnt/` на `/windir/`, вы должны увидеть фиксированный диск C, подключенный к `/windir/c`. |
| параметры  | Список значений, разделенных запятыми, таких как uid, gid и т. д., см. ниже. | пустая строка | Значения параметра automount перечислены ниже и добавляются к строке параметров подключения DrvFs по умолчанию. **Можно указать только параметры, относящиеся к DrvFs.**                                                                                                                                           |

Параметры автоматического подключения применяются в качестве параметров подключения ко всем автоматически подключенным дискам. Чтобы изменить параметры только для определенного диска, используйте `/etc/fstab` файл . Параметры, которые двоичный файл подключения обычно анализирует и преобразовывает во флаг, не поддерживаются. Если вы хотите явно указать эти параметры, необходимо включить каждый диск, для которого требуется сделать это, в `/etc/fstab`.

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#automount-options)

#### Параметры автоматического подключения

Задание различных параметров подключения для дисков Windows (DrvFs) позволяет контролировать определение разрешений для файлов Windows. Доступны следующие варианты:

| Ключ       | Описание                                                                                                                                                                                                                                                                                                     | Значение по умолчанию                                                                                                    |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------ |
| uid        | ИД пользователя, используемый для владельца всех файлов.                                                                                                                                                                                                                                                     | Идентификатор пользователя по умолчанию дистрибутива WSL (при первой установке по умолчанию используется значение 1000). |
| gid        | Идентификатор группы, используемый для владельца всех файлов.                                                                                                                                                                                                                                                | Идентификатор группы по умолчанию дистрибутива WSL (при первой установке значение по умолчанию — 1000).                  |
| umask      | Восьмеричная маска разрешений, исключаемых для всех файлов и каталогов.                                                                                                                                                                                                                                      | 000                                                                                                                      |
| fmask      | Восьмеричная маска разрешений, исключаемых для всех файлов.                                                                                                                                                                                                                                                  | 000                                                                                                                      |
| dmask      | Восьмеричная маска разрешений, исключаемых для всех каталогов.                                                                                                                                                                                                                                               | 000                                                                                                                      |
| метаданные | Добавление метаданных в файлы Windows для поддержки системных разрешений Linux                                                                                                                                                                                                                               | disabled                                                                                                                 |
| case       | Определяет каталоги, для которых учитывается регистр, и будет ли установлен флаг для новых каталогов, созданных с помощью WSL. Подробное описание параметров см. в разделе [Учет регистра](https://learn.microsoft.com/ru-ru/windows/wsl/case-sensitivity) . К параметрам относятся `off`, `dir`или `force`. | `off`                                                                                                                    |

По умолчанию WSL задает для uid и gid значение пользователя по умолчанию. Например, в Ubuntu пользователь по умолчанию — uid=1000, gid=1000. Если это значение используется для указания другого параметра gid или uid, значение пользователя по умолчанию будет перезаписано. В противном случае всегда будет добавляться значение по умолчанию.

Маска режима создания файлов пользователя (umask) задает разрешение для вновь созданных файлов. Значение по умолчанию — 022. Только вы можете записывать данные, но любой пользователь может считывать данные. Значения можно изменить, чтобы они отражали различные параметры разрешений. Например, `umask=077` разрешение изменяется на полностью закрытое, и никто другой пользователь не может читать или записывать данные. Чтобы дополнительно указать разрешение, можно также использовать маску (файлы) и маску (каталоги).

 Примечание

Маски разрешений подвергаются логической операции ИЛИ перед применением к файлам или каталогам.

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#what-is-drvfs)

#### Что такое DrvFs?

DrvFs — это подключаемый модуль файловой системы для WSL, предназначенный для поддержки взаимодействия между WSL и файловой системой Windows. DrvFs позволяет WSL подключать диски с поддерживаемыми файловыми системами в /mnt, например /mnt/c, /mnt/d и т. д. Дополнительные сведения об указании поведения учета регистра по умолчанию при подключении дисков или каталогов Windows или Linux см. на странице [учета регистра](https://learn.microsoft.com/ru-ru/windows/wsl/case-sensitivity) .

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#network-settings)

### Параметры сети

Метка раздела: `[network]`

| ключ               | value      | default          | HDInsight                                                                                                                                                               |
| ------------------ | ---------- | ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| generateHosts      | Логическое | `true`           | Значение `true` указывает WSL создать `/etc/hosts`. Файл `hosts` содержит статическую карту имен узлов и соответствующих IP-адресов.                                    |
| generateResolvConf | Логическое | `true`           | Значение `true` указывает WSL создать `/etc/resolv.conf`. Файл `resolv.conf` содержит список DNS-серверов, которые способны разрешить заданное имя узла в его IP-адрес. |
| hostname           | строка     | Имя узла Windows | Задает имя узла, используемое для распространения WSL.                                                                                                                  |

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#interop-settings)

### Параметры взаимодействия

Метка раздела: `[interop]`

Эти параметры доступны в выпусках для программы предварительной оценки, начиная со сборки 17713.

| ключ              | value      | default | HDInsight                                                                                              |
| ----------------- | ---------- | ------- | ------------------------------------------------------------------------------------------------------ |
| Включено          | Логическое | `true`  | Установка этого ключа определяет, будет ли WSL поддерживать запуск процессов Windows.                  |
| appendWindowsPath | Логическое | `true`  | Задание этого ключа определяет, будет ли WSL добавлять элементы пути Windows в переменную среды $PATH. |

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#user-settings)

### Параметры пользователя

Метка раздела: `[user]`

Эти параметры доступны в сборке 18980 и более поздних версий.

| ключ    | value  | default                                                  | HDInsight                                                                                                    |
| ------- | ------ | -------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| default | строка | Начальное имя пользователя, созданное при первом запуске | Задание этого ключа указывает, от имени какого пользователя будет выполняться при первом запуске сеанса WSL. |

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#boot-settings)

### Параметры загрузки

Параметр загрузки доступен только в Windows 11 и Server 2022.

Метка раздела: `[boot]`

| ключ | value  | default | HDInsight                                                                                                                                                                    |
| ---- | ------ | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| .    | строка | ""      | Строка команды, которую необходимо выполнить при запуске экземпляра WSL. Эта команда выполняется от имени привилегированного пользователя. Например, `service docker start`. |

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#example-wslconf-file)

### Пример файла wsl.conf

В `wsl.conf` примере файла ниже показаны некоторые доступные параметры конфигурации. В этом примере дистрибутивом является Ubuntu-20.04, а путь к файлу — `\\wsl.localhost\Ubuntu-20.04\etc\wsl.conf`.

BashКопировать
    # Automatically mount Windows drive when the distribution is launched
    [automount]

    # Set to true will automount fixed drives (C:/ or D:/) with DrvFs under the root directory set above. Set to false means drives won't be mounted automatically, but need to be mounted manually or with fstab.
    enabled = true

    # Sets the directory where fixed drives will be automatically mounted. This example changes the mount location, so your C-drive would be /c, rather than the default /mnt/c. 
    root = /

    # DrvFs-specific options can be specified.  
    options = "metadata,uid=1003,gid=1003,umask=077,fmask=11,case=off"

    # Sets the `/etc/fstab` file to be processed when a WSL distribution is launched.
    mountFsTab = true

    # Network host settings that enable the DNS server used by WSL 2. This example changes the hostname, sets generateHosts to false, preventing WSL from the default behavior of auto-generating /etc/hosts, and sets generateResolvConf to false, preventing WSL from auto-generating /etc/resolv.conf, so that you can create your own (ie. nameserver 1.1.1.1).
    [network]hostname = DemoHostgenerateHosts = false
    generateResolvConf = false

    # Set whether WSL supports interop process like launching Windows apps and adding path variables. Setting these to false will block the launch of Windows processes and block adding $PATH environment variables.
    [interop]enabled = false
    appendWindowsPath = false

    # Set the user when launching a distribution with WSL.
    [user]default = DemoUser

    # Set a command to run when a new WSL instance launches. This example starts the Docker container service.
    [boot]
    command = service docker start

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#configuration-setting-for-wslconfig)
Параметр конфигурации для WSLCONFIG
-----------------------------------

WSLCONFIG-файл глобально настраивает параметры для всех дистрибутивов Linux, работающих с WSL 2. _(Сведения о конфигурации для каждого распределения см. в разделе [wsl.conf](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconf)._

Сведения о том, где хранить WSLCONFIG-файл, см. в разделе [WSLCONFIG](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#wslconfig) .

 Примечание

Параметры глобальной конфигурации с `.wslconfig` доступны только для дистрибутивов под управлением WSL 2 в сборке Windows 19041 и более поздних версий. Помните, что вам может потребоваться выполнить команду `wsl --shutdown` , чтобы завершить работу виртуальной машины WSL 2, а затем перезапустить экземпляр WSL, чтобы эти изменения повлияли.

Этот файл может содержать следующие параметры, влияющие на виртуальную машину, которая поддерживает любой дистрибутив WSL 2:

Метка раздела: `[wsl2]`

| ключ                 | value       | default                                                                                                                                          | HDInsight                                                                                                                                                                                                                                      |
| -------------------- | ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ядро                 | path        | Предоставленная папка "Входящие" в встроенном ядре Корпорации Майкрософт                                                                         | Абсолютный путь Windows к пользовательскому ядру Linux.                                                                                                                                                                                        |
| Память               | size        | 50 % от общего объема памяти в Windows или 8 ГБ в зависимости от того, что меньше; в сборках до 20175 г.: 80 % от общего объема памяти в Windows | Объем памяти, назначаемой виртуальной машине WSL 2.                                                                                                                                                                                            |
| обработчики          | number      | Одинаковое количество логических процессоров в Windows                                                                                           | Количество логических процессоров, назначаемого виртуальной машине WSL 2.                                                                                                                                                                      |
| localhostForwarding  | Логическое  | `true`                                                                                                                                           | Логическое значение, указывающее, должны ли порты, привязанные к подстановочным знакам или localhost на виртуальной машине WSL 2, подключаться с узла через `localhost:port`.                                                                  |
| kernelCommandLine    | строка      | Пусто                                                                                                                                            | Дополнительные аргументы командной строки ядра.                                                                                                                                                                                                |
| safeMode             | Логическое  | `false`                                                                                                                                          | Запустите WSL в безопасном режиме, который отключает многие функции и предназначен для восстановления дистрибутивов, которые находятся в неправильном состоянии. Доступно только для Windows 11 и WSL версии 0.66.2+.                          |
| swap                 | size        | 25 % объема памяти в Windows округлено до ближайшего ГБ                                                                                          | Объем пространства подкачки, добавляемого к виртуальной машине WSL 2, 0 для отсутствия файла подкачки. Хранилище подкачки — это ОЗУ на диске, которая используется, когда потребность в памяти превышает ограничение на аппаратном устройстве. |
| swapFile             | path        | `%USERPROFILE%\AppData\Local\Temp\swap.vhdx`                                                                                                     | Абсолютный путь Windows к виртуальному жесткому диску подкачки.                                                                                                                                                                                |
| pageReporting        | Логическое  | `true`                                                                                                                                           | Параметр по умолчанию `true` позволяет Windows освободить неиспользуемую память, выделенную виртуальной машине WSL 2.                                                                                                                          |
| guiApplications      | Логических* | `true`                                                                                                                                           | Логическое значение для включения или отключения поддержки приложений с графическим интерфейсом ([WSLg](https://github.com/microsoft/wslg)) в WSL. Доступно только для Windows 11.                                                             |
| debugConsole         | Логических* | `false`                                                                                                                                          | Логическое значение для включения окна консоли вывода, отображающего содержимое при запуске экземпляра дистрибутива `dmesg` WSL 2. Доступно только для Windows 11.                                                                             |
| nestedVirtualization | Логических* | `true`                                                                                                                                           | Логическое значение для включения или отключения вложенной виртуализации, позволяя другим вложенным виртуальным машинам выполняться в WSL 2. Доступно только для Windows 11.                                                                   |
| vmIdleTimeout        | Номер*      | `60000`                                                                                                                                          | Количество миллисекундах, в которых виртуальная машина простаивает перед завершением работы. Доступно только для Windows 11.                                                                                                                   |

Записи со значением `path` должны быть путями Windows с экранируемыми обратными косыми чертами, например: `C:\\Temp\\myCustomKernel`

Записи со значением `size` должны иметь размер, за которым следует единица измерения, например `8GB` или `512MB`.

Записи с символом * после типа значения доступны только на Windows 11.

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#example-wslconfig-file)
Пример WSLCONFIG-файла
----------------------

В `.wslconfig` примере файла ниже показаны некоторые доступные параметры конфигурации. В этом примере путь к файлу — `C:\Users\<UserName>\.wslconfig`.

BashКопировать
    # Settings apply across all Linux distros running on WSL 2
    [wsl2]

    # Limits VM memory to use no more than 4 GB, this can be set as whole numbers using GB or MB
    memory=4GB 

    # Sets the VM to use two virtual processors
    processors=2

    # Specify a custom Linux kernel to use with your installed distros. The default kernel used can be found at https://github.com/microsoft/WSL2-Linux-Kernel
    kernel=C:\\temp\\myCustomKernel

    # Sets additional kernel parameters, in this case enabling older Linux base images such as Centos 6
    kernelCommandLine = vsyscall=emulate

    # Sets amount of swap storage space to 8GB, default is 25% of available RAM
    swap=8GB

    # Sets swapfile path location, default is %USERPROFILE%\AppData\Local\Temp\swap.vhdx
    swapfile=C:\\temp\\wsl-swap.vhdx

    # Disable page reporting so WSL retains all allocated memory claimed from Windows and releases none back when free
    pageReporting=false

    # Turn off default connection to bind WSL 2 localhost to Windows localhost
    localhostforwarding=true

    # Disables nested virtualization
    nestedVirtualization=false

    # Turns on output console showing contents of dmesg when opening a WSL 2 distro for debugging
    debugConsole=true

[](https://learn.microsoft.com/ru-ru/windows/wsl/wsl-config#additional-resources)
Дополнительные ресурсы
----------------------

* [Блог по командной строке Windows: Автоматическая настройка WSL](https://devblogs.microsoft.com/commandline/automatically-configuring-wsl/)
* [Блог командной строки Windows: Chmod/Chown, DrvFs, метаданные файла](https://devblogs.microsoft.com/commandline/chmod-chown-wsl-improvements/)
